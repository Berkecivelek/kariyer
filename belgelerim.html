<!DOCTYPE html>
<html class="light" lang="tr"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Kariyer.ai - Belgelerim Yönetim Ekranı</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<!-- Tailwind CSS -->
<link rel="stylesheet" href="css/tailwind.css">
<style>
    .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    .icon-filled {
        font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#111218] dark:text-white font-display h-screen flex overflow-hidden">
<aside class="w-72 bg-white dark:bg-[#1e2130] flex flex-col h-full border-r border-[#dbdde6] dark:border-gray-700 flex-shrink-0">
<div class="p-6">
<div class="flex items-center gap-3 mb-8">
<div class="bg-primary/10 flex items-center justify-center rounded-xl w-10 h-10 text-primary">
<span class="material-symbols-outlined text-2xl icon-filled">smart_toy</span>
</div>
<div class="flex flex-col">
<h1 class="text-lg font-bold leading-none tracking-tight">Kariyer.ai</h1>
<p class="text-[#616889] dark:text-gray-400 text-xs font-medium mt-1">Yapay Zeka Asistanı</p>
</div>
</div>
<nav class="flex flex-col gap-2">
<a class="flex items-center gap-3 px-4 py-3 rounded-lg text-[#616889] dark:text-gray-300 hover:bg-[#f0f1f4] dark:hover:bg-gray-700 transition-colors" href="dashboard.html">
<span class="material-symbols-outlined">dashboard</span>
<span class="text-sm font-medium">Panel</span>
</a>
<a class="flex items-center gap-3 px-4 py-3 rounded-lg text-[#616889] dark:text-gray-300 hover:bg-[#f0f1f4] dark:hover:bg-gray-700 transition-colors" href="#">
<span class="material-symbols-outlined">auto_awesome</span>
<span class="text-sm font-medium">AI Araçları</span>
</a>
<a class="flex items-center gap-3 px-4 py-3 rounded-lg bg-primary/10 text-primary transition-colors" href="belgelerim.html">
<span class="material-symbols-outlined icon-filled">description</span>
<span class="text-sm font-bold">Belgelerim</span>
</a>
<a class="flex items-center gap-3 px-4 py-3 rounded-lg text-[#616889] dark:text-gray-300 hover:bg-[#f0f1f4] dark:hover:bg-gray-700 transition-colors" href="profil-ayarlari.html">
<span class="material-symbols-outlined">person</span>
<span class="text-sm font-medium">Profil Ayarları</span>
</a>
<a class="flex items-center gap-3 px-4 py-3 rounded-lg text-[#616889] dark:text-gray-300 hover:bg-[#f0f1f4] dark:hover:bg-gray-700 transition-colors" href="#">
<span class="material-symbols-outlined">credit_card</span>
<span class="text-sm font-medium">Abonelik</span>
</a>
</nav>
</div>
<div class="mt-auto p-6 border-t border-[#dbdde6] dark:border-gray-700">
<div class="flex items-center gap-3">
<div class="relative">
<div id="sidebar-user-avatar" class="w-10 h-10 rounded-full bg-cover bg-center" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuAcTIYvmjbxiSGytgkAfyEs2Tt5Oh05X4BXwXWS1ENVGBpPUHndF37DRX9sAmm4tbVOgyEel42gBLITY1W-dOEwZNHsCwL3UU_YTHHzXsGWmis8QiQGilU8XcmcytFKEcTXNAPr19UrAqTkbrG_zB84LeJe7wLDlxERB1Nf-wdDNkqBNVtAzEmGdcyBgeynGaayNFauTdna9Y-cN0Wd3VJhVzUrNNIc2VUfvxM0-N-ScBfc2wA49ahN5Ozw0Jqboma-OY8o3jUUjD4p');"></div>
<div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white dark:border-[#1e2130] rounded-full"></div>
</div>
<div class="flex flex-col overflow-hidden">
<p id="sidebar-user-name" class="text-sm font-bold truncate text-[#111218] dark:text-white">Yükleniyor...</p>
<p id="sidebar-user-plan" class="text-xs text-[#616889] dark:text-gray-400 truncate">Yükleniyor...</p>
</div>
<button id="sidebar-logout-btn" class="ml-auto text-[#616889] hover:text-[#111218] dark:hover:text-white">
<span class="material-symbols-outlined">logout</span>
</button>
</div>
</div>
</aside>
<main class="flex-1 flex flex-col h-full overflow-y-auto relative">
<div class="max-w-[1400px] w-full mx-auto p-6 md:p-8 lg:p-10 flex flex-col gap-8">
<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
<div class="flex flex-col gap-1">
<h1 class="text-3xl md:text-4xl font-black tracking-tight text-[#111218] dark:text-white">Belgelerim</h1>
<p class="text-[#616889] dark:text-gray-400 text-base font-medium">Tüm özgeçmiş, ön yazı ve portfolyolarını buradan yönetebilirsin.</p>
</div>
<button id="create-new-doc-btn" class="flex items-center gap-2 bg-primary hover:bg-primary-dark text-white px-6 py-3.5 rounded-xl font-bold text-sm shadow-lg shadow-primary/20 transition-all active:scale-95">
<span class="material-symbols-outlined">add_circle</span>
                Yeni Belge Oluştur
            </button>
</div>
<div class="bg-white dark:bg-[#1e2130] border border-[#dbdde6] dark:border-gray-700 rounded-2xl p-4 flex flex-col lg:flex-row items-center justify-between gap-4">
<div class="relative w-full lg:w-96">
<div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
<span class="material-symbols-outlined text-[#616889] dark:text-gray-500 text-xl">search</span>
</div>
<input id="search-input" class="block w-full pl-11 pr-4 py-3 border-none rounded-xl bg-[#f6f6f8] dark:bg-gray-800 text-[#111218] dark:text-white placeholder-[#616889] dark:placeholder-gray-500 focus:ring-2 focus:ring-primary text-sm font-medium transition-all" placeholder="Döküman adı veya anahtar kelime ara..." type="text"/>
</div>
<div class="flex items-center gap-2 w-full lg:w-auto overflow-x-auto no-scrollbar pb-1 lg:pb-0">
<button data-filter="all" class="filter-btn px-5 py-2.5 rounded-lg bg-primary text-white text-sm font-bold whitespace-nowrap">
                    Tümü
                </button>
<button data-filter="resume" class="filter-btn px-5 py-2.5 rounded-lg text-[#616889] dark:text-gray-400 hover:bg-[#f0f1f4] dark:hover:bg-gray-800 text-sm font-bold transition-all whitespace-nowrap">
                    Özgeçmişler
                </button>
<button data-filter="cover-letter" class="filter-btn px-5 py-2.5 rounded-lg text-[#616889] dark:text-gray-400 hover:bg-[#f0f1f4] dark:hover:bg-gray-800 text-sm font-bold transition-all whitespace-nowrap">
                    Ön Yazılar
                </button>
<button data-filter="portfolio" class="filter-btn px-5 py-2.5 rounded-lg text-[#616889] dark:text-gray-400 hover:bg-[#f0f1f4] dark:hover:bg-gray-800 text-sm font-bold transition-all whitespace-nowrap">
                    Portfolyolar
                </button>
<div class="h-6 w-px bg-[#dbdde6] dark:bg-gray-700 mx-2 hidden sm:block"></div>
<div class="flex items-center gap-2">
<span class="text-xs font-bold text-[#616889] dark:text-gray-500 uppercase tracking-wider">Sırala:</span>
<select id="sort-select" class="bg-transparent border-none text-sm font-bold text-[#111218] dark:text-white focus:ring-0 cursor-pointer">
<option value="newest">En Yeni</option>
<option value="oldest">En Eski</option>
<option value="name-asc">İsim (A-Z)</option>
<option value="name-desc">İsim (Z-A)</option>
</select>
</div>
</div>
</div>
<div id="documents-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6 pb-20">
<!-- Documents will be loaded here dynamically -->
</div>
</div>
</main>

<!-- API Client -->
<script src="js/api-client.js"></script>
<script src="js/auth-guard.js"></script>
<script src="js/auth-header.js"></script>
<script src="js/cv-template-renderer.js"></script>
<script>
(function() {
    'use strict';
    
    let allDocuments = [];
    let filteredDocuments = [];
    let currentFilter = 'all';
    let currentSort = 'newest';
    
    // API client'ın yüklenmesini bekle
    function waitForAPIClient(callback) {
        if (window.apiClient) {
            callback();
        } else {
            setTimeout(() => waitForAPIClient(callback), 100);
        }
    }
    
    // Kullanıcı bilgilerini yükle
    async function loadUserProfile() {
        try {
            const response = await window.apiClient.getCurrentUser();
            if (response.success && response.data.user) {
                const user = response.data.user;
                const sidebarUserName = document.getElementById('sidebar-user-name');
                const sidebarUserPlan = document.getElementById('sidebar-user-plan');
                
                if (sidebarUserName) {
                    const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email;
                    sidebarUserName.textContent = fullName;
                }
                if (sidebarUserPlan) {
                    sidebarUserPlan.textContent = 'Pro Plan Üyesi';
                }
            }
        } catch (error) {
            console.error('Kullanıcı bilgisi yükleme hatası:', error);
        }
    }
    
    // Tüm belgeleri yükle (CV'ler, Ön Yazılar, Portfolyolar)
    async function loadAllDocuments() {
        try {
            // CV'leri yükle - TÜM CV'leri al (DRAFT, COMPLETED, ARCHIVED)
            const resumesResponse = await window.apiClient.getResumes(true);
            const resumes = resumesResponse.success && resumesResponse.data.resumes ? resumesResponse.data.resumes : [];
            
            // CV'leri document formatına dönüştür
            const resumeDocuments = resumes.map(resume => ({
                id: resume.id,
                type: 'resume',
                title: resume.title || 'Yeni Özgeçmiş',
                status: resume.status || 'DRAFT',
                updatedAt: resume.updatedAt,
                createdAt: resume.createdAt,
                data: resume
            }));
            
            // Ön Yazıları yükle (cover letters)
            const coverLetterDocuments = [];
            try {
                const coverLettersResponse = await window.apiClient.getCoverLetters();
                if (coverLettersResponse.success && coverLettersResponse.data && coverLettersResponse.data.coverLetters) {
                    coverLettersResponse.data.coverLetters.forEach(coverLetter => {
                        coverLetterDocuments.push({
                            id: coverLetter.id,
                            type: 'cover-letter',
                            title: coverLetter.title || 'Ön Yazı',
                            content: coverLetter.content,
                            createdAt: coverLetter.createdAt,
                            updatedAt: coverLetter.updatedAt,
                            position: coverLetter.position,
                            company: coverLetter.company,
                        });
                    });
                }
            } catch (error) {
                console.error('Failed to load cover letters:', error);
            }
            // TODO: Portfolyoları yükle (portfolios)
            
            // Tüm belgeleri birleştir
            allDocuments = [...resumeDocuments, ...coverLetterDocuments];
            filteredDocuments = [...allDocuments];
            
            renderDocuments();
        } catch (error) {
            console.error('Belgeler yükleme hatası:', error);
        }
    }
    
    // Belgeleri render et
    function renderDocuments() {
        const grid = document.getElementById('documents-grid');
        if (!grid) return;
        
        // Mevcut kartları temizle
        grid.innerHTML = '';
        
        // Filtreleme
        let filtered = [...filteredDocuments];
        if (currentFilter !== 'all') {
            filtered = filtered.filter(doc => doc.type === currentFilter);
        }
        
        // Sıralama
        filtered.sort((a, b) => {
            if (currentSort === 'newest') {
                return new Date(b.updatedAt) - new Date(a.updatedAt);
            } else if (currentSort === 'oldest') {
                return new Date(a.updatedAt) - new Date(b.updatedAt);
            } else if (currentSort === 'name-asc') {
                return a.title.localeCompare(b.title, 'tr');
            } else if (currentSort === 'name-desc') {
                return b.title.localeCompare(a.title, 'tr');
            }
            return 0;
        });
        
        // Arama
        const searchInput = document.getElementById('search-input');
        if (searchInput && searchInput.value.trim()) {
            const searchTerm = searchInput.value.trim().toLowerCase();
            filtered = filtered.filter(doc => 
                doc.title.toLowerCase().includes(searchTerm) ||
                (doc.data.firstName && doc.data.firstName.toLowerCase().includes(searchTerm)) ||
                (doc.data.lastName && doc.data.lastName.toLowerCase().includes(searchTerm))
            );
        }
        
        // Kartları oluştur
        filtered.forEach(doc => {
            const card = createDocumentCard(doc);
            grid.appendChild(card);
        });
        
        // "Yeni Belge Ekle" kartını ekle
        const createCard = createNewDocumentCard();
        if (createCard) {
            createCard.addEventListener('click', () => {
                window.location.href = 'cv-olusturucu-kisisel-bilgiler.html';
            });
            grid.appendChild(createCard);
        }
    }
    
    // CV kartı oluştur
    function createDocumentCard(doc) {
        const card = document.createElement('div');
        card.className = 'group flex flex-col bg-white dark:bg-[#1e2130] border border-[#dbdde6] dark:border-gray-700 rounded-2xl overflow-hidden hover:shadow-2xl hover:border-primary/40 transition-all duration-300 relative';
        card.setAttribute('data-doc-id', doc.id);
        card.setAttribute('data-doc-type', doc.type);
        
        // Status badge
        let statusBadge = '';
        if (doc.status === 'COMPLETED') {
            statusBadge = '<span class="flex items-center gap-1.5 text-[11px] font-bold px-3 py-1 rounded-full bg-green-50 text-green-700 dark:bg-green-900/20 dark:text-green-400 border border-green-100 dark:border-green-800/30"><span class="w-2 h-2 rounded-full bg-green-500"></span>Tamamlandı</span>';
        } else if (doc.status === 'DRAFT') {
            statusBadge = '<span class="flex items-center gap-1.5 text-[11px] font-bold px-3 py-1 rounded-full bg-yellow-50 text-yellow-700 dark:bg-yellow-900/20 dark:text-yellow-400 border border-yellow-100 dark:border-yellow-800/30"><span class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span>Taslak</span>';
        } else if (doc.status === 'ARCHIVED') {
            statusBadge = '<span class="flex items-center gap-1.5 text-[11px] font-bold px-3 py-1 rounded-full bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400 border border-gray-200 dark:border-gray-700">Arşiv</span>';
        }
        
        // Type badge
        let typeBadge = '';
        let typeColor = 'text-primary';
        if (doc.type === 'resume') {
            typeBadge = 'Özgeçmiş';
            typeColor = 'text-primary';
        } else if (doc.type === 'cover-letter') {
            typeBadge = 'Ön Yazı';
            typeColor = 'text-purple-600';
        } else if (doc.type === 'portfolio') {
            typeBadge = 'Portfolyo';
            typeColor = 'text-blue-600';
        }
        
        // Preview container - CV veya Cover Letter önizlemesi
        let previewHTML = '';
        if (doc.type === 'resume') {
            previewHTML = generateCVPreview(doc.data);
        } else if (doc.type === 'cover-letter') {
            previewHTML = generateCoverLetterPreview(doc);
        } else {
            previewHTML = '<div class="p-4 text-center text-gray-400">Önizleme yok</div>';
        }
        
        // Tarih formatı
        const updatedDate = new Date(doc.updatedAt);
        const now = new Date();
        const diffTime = Math.abs(now - updatedDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        let dateText = '';
        if (diffDays === 0) {
            dateText = 'Bugün';
        } else if (diffDays === 1) {
            dateText = 'Dün';
        } else if (diffDays < 7) {
            dateText = `${diffDays} gün önce`;
        } else {
            const months = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
            dateText = `${updatedDate.getDate()} ${months[updatedDate.getMonth()]}`;
        }
        
        card.innerHTML = `
            <div class="relative h-48 bg-gray-100 dark:bg-gray-800 overflow-hidden border-b border-[#dbdde6] dark:border-gray-700">
                <!-- CV Preview Container - Dashboard'daki gibi -->
                <div class="absolute inset-0 bg-gradient-to-br from-slate-500 via-slate-600 to-slate-700 overflow-hidden">
                    <div class="absolute inset-0 flex items-center justify-center p-2.5">
                        <div class="bg-white rounded-md shadow-2xl overflow-hidden relative" style="width: 70%; height: 80%; box-shadow: 0 8px 20px rgba(0,0,0,0.4);">
                            <div class="w-full h-full overflow-hidden" style="transform: scale(0.22); transform-origin: top left; width: 454.55%; height: 454.55%; pointer-events: none;" data-resume-preview="${doc.id}">
                                <div class="w-full h-full p-5" style="background: white; min-height: 100%; font-family: system-ui, -apple-system, sans-serif;">
                                    ${previewHTML}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="absolute top-4 left-4">
                    <span class="px-3 py-1.5 rounded-lg bg-white/95 dark:bg-gray-900/95 text-[11px] font-extrabold uppercase tracking-widest ${typeColor} shadow-lg backdrop-blur-sm border border-primary/10">${typeBadge}</span>
                </div>
            </div>
            <div class="p-5 flex flex-col flex-1">
                <div class="flex justify-between items-start mb-1">
                    <h3 class="font-bold text-[#111218] dark:text-white text-lg line-clamp-1 group-hover:text-primary transition-colors">${escapeHtml(doc.title)}</h3>
                </div>
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-xs text-[#616889] dark:text-gray-400">Son Düzenleme: ${dateText}</span>
                </div>
                <div class="flex items-center mb-6">
                    ${statusBadge}
                </div>
                <div class="mt-auto grid grid-cols-4 gap-2 border-t border-[#f0f1f4] dark:border-gray-700/50 pt-4">
                    <button class="edit-btn flex flex-col items-center gap-1 group/btn" data-doc-id="${doc.id}" data-doc-type="${doc.type}" title="Düzenle">
                        <div class="p-2.5 rounded-lg bg-primary/10 text-primary group-hover/btn:bg-primary group-hover/btn:text-white transition-all">
                            <span class="material-symbols-outlined text-xl">edit</span>
                        </div>
                        <span class="text-[10px] font-bold text-[#616889] dark:text-gray-500 group-hover/btn:text-primary">Düzenle</span>
                    </button>
                    <button class="download-btn flex flex-col items-center gap-1 group/btn" data-doc-id="${doc.id}" data-doc-type="${doc.type}" title="İndir">
                        <div class="p-2.5 rounded-lg bg-[#f6f6f8] dark:bg-gray-800 text-[#616889] dark:text-gray-400 group-hover/btn:bg-blue-500 group-hover/btn:text-white transition-all">
                            <span class="material-symbols-outlined text-xl">download</span>
                        </div>
                        <span class="text-[10px] font-bold text-[#616889] dark:text-gray-500 group-hover/btn:text-blue-500">İndir</span>
                    </button>
                    <button class="copy-btn flex flex-col items-center gap-1 group/btn" data-doc-id="${doc.id}" data-doc-type="${doc.type}" title="Kopyala">
                        <div class="p-2.5 rounded-lg bg-[#f6f6f8] dark:bg-gray-800 text-[#616889] dark:text-gray-400 group-hover/btn:bg-purple-500 group-hover/btn:text-white transition-all">
                            <span class="material-symbols-outlined text-xl">content_copy</span>
                        </div>
                        <span class="text-[10px] font-bold text-[#616889] dark:text-gray-500 group-hover/btn:text-purple-500">Kopyala</span>
                    </button>
                    <button class="delete-btn flex flex-col items-center gap-1 group/btn" data-doc-id="${doc.id}" data-doc-type="${doc.type}" title="Sil">
                        <div class="p-2.5 rounded-lg bg-[#f6f6f8] dark:bg-gray-800 text-[#616889] dark:text-gray-400 group-hover/btn:bg-red-500 group-hover/btn:text-white transition-all">
                            <span class="material-symbols-outlined text-xl">delete</span>
                        </div>
                        <span class="text-[10px] font-bold text-[#616889] dark:text-gray-500 group-hover/btn:text-red-500">Sil</span>
                    </button>
                </div>
            </div>
        `;
        
        // Event listeners
        const editBtn = card.querySelector('.edit-btn');
        const downloadBtn = card.querySelector('.download-btn');
        const copyBtn = card.querySelector('.copy-btn');
        const deleteBtn = card.querySelector('.delete-btn');
        
        if (editBtn) {
            editBtn.addEventListener('click', () => handleEdit(doc));
        }
        if (downloadBtn) {
            downloadBtn.addEventListener('click', () => handleDownload(doc));
        }
        if (copyBtn) {
            copyBtn.addEventListener('click', () => handleCopy(doc));
        }
        if (deleteBtn) {
            deleteBtn.addEventListener('click', () => handleDelete(doc));
        }
        
        return card;
    }
    
    // CV önizlemesi oluştur (Dashboard'daki gibi)
    function generateCVPreview(resumeData) {
        if (!resumeData) return '';
        
        // CV verilerini template formatına dönüştür
        const cvDataForPreview = {
            'fullname-first': resumeData.firstName || '',
            'fullname-last': resumeData.lastName || '',
            email: resumeData.email || '',
            phone: resumeData.phone || '',
            location: resumeData.location || '',
            profession: resumeData.profession || '',
            summary: resumeData.summary || '',
            experiences: Array.isArray(resumeData.experience) ? resumeData.experience : [],
            education: Array.isArray(resumeData.education) ? resumeData.education : [],
            skills: Array.isArray(resumeData.skills) ? resumeData.skills : [],
            languages: Array.isArray(resumeData.languages) ? resumeData.languages : [],
        };
        
        // Template renderer kullan
        if (window.CVTemplateRenderer && window.CVTemplateRenderer.render) {
            try {
                const templateName = resumeData.templateId || 'modern';
                return window.CVTemplateRenderer.render(templateName, cvDataForPreview);
            } catch (error) {
                console.warn('CV preview render hatası:', error);
                return generateSimplePreview(cvDataForPreview);
            }
        } else {
            return generateSimplePreview(cvDataForPreview);
        }
    }
    
    // Basit preview oluştur
    function generateSimplePreview(cvData) {
        const expCount = cvData.experiences.length;
        const eduCount = cvData.education.length;
        const skillsCount = cvData.skills.length;
        const langCount = cvData.languages.length;
        
        return `
            <div class="p-4" style="background: white; min-height: 100%; font-family: system-ui, -apple-system, sans-serif;">
                <div class="mb-3 border-b-2 border-slate-800 pb-3">
                    <h1 class="text-2xl font-bold text-slate-900 mb-1">${escapeHtml(cvData['fullname-first'] + ' ' + cvData['fullname-last'])}</h1>
                    <p class="text-sm text-slate-600 font-medium">${escapeHtml(cvData.profession || '')}</p>
                </div>
                ${cvData.summary ? `<div class="mb-3 pb-3 border-b border-slate-200"><p class="text-xs text-slate-600 leading-relaxed">${escapeHtml(cvData.summary.substring(0, 120))}${cvData.summary.length > 120 ? '...' : ''}</p></div>` : ''}
                ${expCount > 0 ? `<div class="mb-2"><h3 class="text-xs font-bold uppercase text-slate-800 mb-1 border-b border-slate-300 pb-1">DENEYİM</h3><p class="text-xs text-slate-600">${expCount} deneyim</p></div>` : ''}
                ${eduCount > 0 ? `<div class="mb-2"><h3 class="text-xs font-bold uppercase text-slate-800 mb-1 border-b border-slate-300 pb-1">EĞİTİM</h3><p class="text-xs text-slate-600">${eduCount} eğitim</p></div>` : ''}
                ${skillsCount > 0 ? `<div class="mb-2"><h3 class="text-xs font-bold uppercase text-slate-800 mb-1 border-b border-slate-300 pb-1">YETENEKLER</h3><p class="text-xs text-slate-600">${skillsCount} yetenek</p></div>` : ''}
                ${langCount > 0 ? `<div class="mb-2"><h3 class="text-xs font-bold uppercase text-slate-800 mb-1 border-b border-slate-300 pb-1">DİLLER</h3><p class="text-xs text-slate-600">${langCount} dil</p></div>` : ''}
            </div>
        `;
    }
    
    // Cover letter önizlemesi oluştur
    function generateCoverLetterPreview(doc) {
        const content = doc.content || '';
        const preview = content.substring(0, 300) + (content.length > 300 ? '...' : '');
        const lines = preview.split('\n').slice(0, 8); // İlk 8 satır
        
        return `
            <div class="p-4" style="background: white; min-height: 100%; font-family: system-ui, -apple-system, sans-serif;">
                <div class="mb-3 border-b-2 border-purple-600 pb-2">
                    <h1 class="text-xl font-bold text-purple-700 mb-1">ÖN YAZI</h1>
                </div>
                <div class="space-y-2">
                    ${lines.map(line => `<p class="text-xs text-slate-700 leading-relaxed">${escapeHtml(line || '')}</p>`).join('')}
                </div>
            </div>
        `;
    }
    
    // "Yeni Belge Ekle" kartı
    function createNewDocumentCard() {
        const card = document.createElement('button');
        card.className = 'group flex flex-col items-center justify-center min-h-[420px] rounded-2xl border-2 border-dashed border-[#dbdde6] dark:border-gray-700 hover:border-primary hover:bg-white dark:hover:bg-[#1e2130] transition-all cursor-pointer gap-5';
        card.id = 'create-new-doc-card-btn';
        card.innerHTML = `
            <div class="w-20 h-20 rounded-full bg-[#f0f1f4] dark:bg-gray-800 group-hover:bg-primary/10 flex items-center justify-center transition-all">
                <span class="material-symbols-outlined text-4xl text-[#616889] group-hover:text-primary transition-colors">add</span>
            </div>
            <div class="flex flex-col items-center gap-2">
                <span class="text-lg font-bold text-[#111218] dark:text-white">Yeni Belge Ekle</span>
                <p class="text-sm text-[#616889] dark:text-gray-400 text-center max-w-[160px]">Saniyeler içinde AI ile yeni bir döküman oluştur</p>
            </div>
        `;
        return card;
    }
    
    // Event handlers
    function handleEdit(doc) {
        if (doc.type === 'resume') {
            window.location.href = `cv-olusturucu-kisisel-bilgiler.html?resume=${doc.id}`;
        } else if (doc.type === 'cover-letter') {
            // Ön yazı düzenleme sayfasına yönlendir
            window.location.href = `on-yazi-olusturucu.html?edit=${doc.id}`;
        } else if (doc.type === 'portfolio') {
            // TODO: Portfolyo düzenleme sayfasına yönlendir
            console.log('Portfolyo düzenleme:', doc.id);
        }
    }
    
    function handleDownload(doc) {
        if (doc.type === 'resume') {
            window.downloadPDF(doc.id);
        } else {
            // TODO: Diğer belge tipleri için indirme
            console.log('İndir:', doc.type, doc.id);
        }
    }
    
    function handleCopy(doc) {
        if (doc.type === 'resume') {
            // TODO: CV kopyalama
            console.log('Kopyala:', doc.id);
            alert('CV kopyalama özelliği yakında eklenecek.');
        } else {
            console.log('Kopyala:', doc.type, doc.id);
        }
    }
    
    function handleDelete(doc) {
        if (confirm(`"${doc.title}" adlı belgeyi silmek istediğinize emin misiniz?`)) {
            if (doc.type === 'resume') {
                window.apiClient.deleteResume(doc.id)
                    .then(() => {
                        loadAllDocuments();
                    })
                    .catch(error => {
                        console.error('Silme hatası:', error);
                        alert('Belge silinemedi: ' + (error.message || 'Bilinmeyen hata'));
                    });
            } else if (doc.type === 'cover-letter') {
                window.apiClient.deleteCoverLetter(doc.id)
                    .then(() => {
                        loadAllDocuments();
                    })
                    .catch(error => {
                        console.error('Silme hatası:', error);
                        alert('Ön yazı silinemedi: ' + (error.message || 'Bilinmeyen hata'));
                    });
            } else {
                // TODO: Diğer belge tipleri için silme
                console.log('Sil:', doc.type, doc.id);
            }
        }
    }
    
    // Utility functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Filtreleme
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('bg-primary', 'text-white');
                b.classList.add('text-[#616889]', 'dark:text-gray-400', 'hover:bg-[#f0f1f4]', 'dark:hover:bg-gray-800');
            });
            btn.classList.add('bg-primary', 'text-white');
            btn.classList.remove('text-[#616889]', 'dark:text-gray-400', 'hover:bg-[#f0f1f4]', 'dark:hover:bg-gray-800');
            currentFilter = btn.getAttribute('data-filter');
            renderDocuments();
        });
    });
    
    // Sıralama
    const sortSelect = document.getElementById('sort-select');
    if (sortSelect) {
        sortSelect.addEventListener('change', (e) => {
            currentSort = e.target.value;
            renderDocuments();
        });
    }
    
    // Arama
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                renderDocuments();
            }, 300);
        });
    }
    
    // Yeni belge oluştur
    const createNewDocBtn = document.getElementById('create-new-doc-btn');
    if (createNewDocBtn) {
        createNewDocBtn.addEventListener('click', () => {
            window.location.href = 'cv-olusturucu-kisisel-bilgiler.html';
        });
    }
    
    // "Yeni Belge Ekle" kartı event listener'ı renderDocuments içinde ekleniyor
    
    // Çıkış yap
    const sidebarLogoutBtn = document.getElementById('sidebar-logout-btn');
    if (sidebarLogoutBtn) {
        sidebarLogoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                if (window.apiClient) {
                    await window.apiClient.logout();
                } else {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('refreshToken');
                }
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Çıkış hatası:', error);
                localStorage.removeItem('authToken');
                localStorage.removeItem('refreshToken');
                window.location.href = 'index.html';
            }
        });
    }
    
    // PDF indir fonksiyonu (dashboard'dan kopyala)
    window.downloadPDF = async function(resumeId) {
        const url = `${window.apiClient.baseURL}/resumes/${resumeId}/pdf`;
        
        try {
            const response = await fetch(url, {
                headers: {
                    Authorization: `Bearer ${window.apiClient.token}`,
                },
            });

            if (!response.ok) {
                let errorMessage = 'PDF indirilemedi';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error?.message || errorData.message || errorMessage;
                } catch (e) {
                    errorMessage = response.statusText || `HTTP ${response.status}`;
                }
                throw new Error(errorMessage);
            }

            const blob = await response.blob();
            const url_blob = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url_blob;
            a.download = `ozgecmis-${resumeId}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url_blob);
        } catch (error) {
            console.error('PDF indirme hatası:', error);
            alert('PDF indirilemedi: ' + (error.message || 'Bilinmeyen bir hata oluştu'));
        }
    };
    
    // Sayfa yüklendiğinde başlat
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            waitForAPIClient(() => {
                loadUserProfile();
                loadAllDocuments();
            });
        });
    } else {
        waitForAPIClient(() => {
            loadUserProfile();
            loadAllDocuments();
        });
    }
    
    // CV Template Renderer yüklenmesini bekle
    function waitForTemplateRenderer(callback) {
        if (window.CVTemplateRenderer && window.CVTemplateRenderer.render) {
            callback();
        } else {
            setTimeout(() => waitForTemplateRenderer(callback), 100);
        }
    }
    
    // Template renderer yüklendikten sonra belgeleri yeniden render et
    waitForTemplateRenderer(() => {
        if (allDocuments.length > 0) {
            renderDocuments();
        }
    });
})();
</script>
</body></html>

